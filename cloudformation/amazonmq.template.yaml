---
AWSTemplateFormatVersion: '2010-09-09'
Description: Magento 2.* Amazon MQ (RabbitMQ) Template (Gluo)
Parameters:
  BrokerUsername:
    Description: User-defined AmazonMQ username
    Type: String
    Default: 'rabbit'
  BrokerPassword:
    Description: User-defined AmazonMQ password
    Type: String
    Default: 'simplepassword'
    NoEcho: true
  BrokerInstanceType:
    AllowedValues:
    - mq.t3.micro
    - mq.t2.medium
    Description: AmazonMQ instance type
    Type: String
    Default: 'mq.t3.micro'
  RabbitVersion:
    Description: The RabbitMQ version to deploy
    Type: String
    Default: "3.8.6"
  BrokerSecurityGroup:
    Description: The Security Group to protect RabbitMQ
    Type: AWS::EC2::SecurityGroup::Id
  BrokerSubnetIds:
    Description: The Subnet to run RabbitMQ
    Type: AWS::EC2::Subnet::Id
Resources:
  AmazonMQBroker:
    Type: "AWS::AmazonMQ::Broker"
    Properties:
      AutoMinorVersionUpgrade: true
      BrokerName: !Join ["-", ['RabbitMQ-Magento', !Select [0, !Split ["-", !Sub "${AWS::StackName}"]]]]
      DeploymentMode: SINGLE_INSTANCE
      EngineType: RABBITMQ
      EngineVersion: !Ref RabbitVersion
      HostInstanceType: !Ref BrokerInstanceType
      PubliclyAccessible: false
      Users:
        -
          ConsoleAccess: true
          Groups: 
            - Administrators
          Username: !Ref BrokerUsername
          Password: !Ref BrokerPassword
      SecurityGroups:
        - !Ref BrokerSecurityGroup
      SubnetIds:
        - !Ref BrokerSubnetIds
      Tags: 
      - Key: Name
        Value: !Sub AmazonMQ-${AWS::StackName}